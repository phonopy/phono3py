"""Test spectral_function.py."""
import numpy as np

from phono3py import Phono3py
from phono3py.phonon3.spectral_function import SpectralFunction

shifts = [
    -0.0049592,
    -0.0049592,
    -0.0120983,
    -0.1226471,
    -0.1214069,
    -0.1214069,
    -0.0051678,
    -0.0051678,
    -0.0128471,
    -0.1224616,
    -0.1200362,
    -0.1200362,
    -0.0055308,
    -0.0055308,
    -0.0122157,
    -0.1093754,
    -0.1077399,
    -0.1077399,
    -0.0037992,
    -0.0037992,
    -0.0089979,
    -0.0955525,
    -0.0958995,
    -0.0958995,
    -0.0034397,
    -0.0034397,
    -0.0107575,
    -0.1068741,
    -0.1067815,
    -0.1067815,
    -0.0017800,
    -0.0017800,
    -0.0102865,
    -0.1348585,
    -0.1275650,
    -0.1275650,
    0.0006728,
    0.0006728,
    -0.0065349,
    -0.2011702,
    -0.2015991,
    -0.2015991,
    0.0021133,
    0.0021133,
    0.0020353,
    -0.0740009,
    -0.0833644,
    -0.0833644,
    0.0037739,
    0.0037739,
    0.0121357,
    0.1597195,
    0.1585307,
    0.1585307,
    0.0026257,
    0.0026257,
    0.0103523,
    0.1626420,
    0.1634832,
    0.1634832,
    -0.0189694,
    -0.0188985,
    -0.0415773,
    -0.0955391,
    -0.1180182,
    -0.1126508,
    -0.0194533,
    -0.0191057,
    -0.0420358,
    -0.0913521,
    -0.1140995,
    -0.1075009,
    -0.0233933,
    -0.0219600,
    -0.0466734,
    -0.0865867,
    -0.1086070,
    -0.1014454,
    -0.0140271,
    -0.0150165,
    -0.0344515,
    -0.0755416,
    -0.1018518,
    -0.0951606,
    -0.0058780,
    -0.0089457,
    -0.0256867,
    -0.0775726,
    -0.1070427,
    -0.1018654,
    -0.0069737,
    -0.0092857,
    -0.0333909,
    -0.1014042,
    -0.1320678,
    -0.1288315,
    -0.0030075,
    -0.0060858,
    -0.0245855,
    -0.1186313,
    -0.1963719,
    -0.1857004,
    0.0058243,
    0.0030539,
    -0.0049966,
    -0.0583228,
    -0.0921850,
    -0.0893692,
    0.0141517,
    0.0149365,
    0.0312156,
    0.0898626,
    0.1454759,
    0.1347802,
    0.0110954,
    0.0137260,
    0.0427527,
    0.1280421,
    0.1715647,
    0.1648037,
]

spec_funcs = [
    -0.0000000,
    -0.0000000,
    0.0000000,
    -0.0000000,
    -0.0000000,
    -0.0000000,
    0.0000165,
    0.0000165,
    0.0022357,
    0.0001249,
    0.0001318,
    0.0001318,
    0.0000027,
    0.0000027,
    0.0000592,
    0.0005056,
    0.0004722,
    0.0004722,
    0.0000016,
    0.0000016,
    0.0000118,
    0.0008887,
    0.0008281,
    0.0008281,
    0.0000001,
    0.0000001,
    0.0000007,
    0.0062806,
    0.0053809,
    0.0053809,
    0.0000003,
    0.0000003,
    0.0000026,
    0.0025466,
    0.0035400,
    0.0035400,
    0.0000001,
    0.0000001,
    0.0000010,
    0.0004469,
    0.0002613,
    0.0002613,
    0.0000001,
    0.0000001,
    0.0000011,
    0.0011874,
    0.0012518,
    0.0012518,
    0.0000000,
    0.0000000,
    0.0000003,
    0.0002964,
    0.0003119,
    0.0003119,
    0.0000000,
    0.0000000,
    0.0000000,
    0.0000000,
    0.0000000,
    0.0000000,
    0.0000000,
    -0.0000000,
    0.0000000,
    0.0000000,
    0.0000000,
    0.0000000,
    0.0032185,
    0.0005560,
    0.0001434,
    0.0001868,
    0.0001602,
    0.0001670,
    0.0000726,
    0.0002220,
    0.0016122,
    0.0004059,
    0.0003461,
    0.0003024,
    0.0000878,
    0.0001280,
    0.0033720,
    0.0027162,
    0.0013271,
    0.0011427,
    0.0000049,
    0.0000094,
    0.0000892,
    0.0137571,
    0.0405108,
    0.0173674,
    0.0000052,
    0.0000084,
    0.0000567,
    0.0005807,
    0.0013438,
    0.0014025,
    0.0000021,
    0.0000034,
    0.0000405,
    0.0003176,
    0.0003022,
    0.0003523,
    0.0000019,
    0.0000034,
    0.0000235,
    0.0003419,
    0.0008701,
    0.0008436,
    0.0000004,
    0.0000010,
    0.0000162,
    0.0001759,
    0.0002910,
    0.0002978,
    0.0000000,
    0.0000000,
    0.0000000,
    0.0000000,
    0.0000000,
    0.0000000,
]


def test_SpectralFunction(si_pbesol: Phono3py):
    """Spectral function of Si."""
    si_pbesol.mesh_numbers = [9, 9, 9]
    si_pbesol.init_phph_interaction()
    sf = SpectralFunction(
        si_pbesol.phph_interaction,
        si_pbesol.grid.grg2bzg[[1, 103]],
        temperatures=[
            300,
        ],
        num_frequency_points=10,
        log_level=1,
    )
    sf.run()

    # for line in np.swapaxes(sf.spectral_functions, -2, -1).reshape(-1, 6):
    #     print(("%.7f, " * 6) % tuple(line))
    # raise

    np.testing.assert_allclose(
        shifts, np.swapaxes(sf.shifts, -2, -1).ravel(), atol=1e-2
    )
    np.testing.assert_allclose(
        spec_funcs,
        np.swapaxes(sf.spectral_functions, -2, -1).ravel(),
        atol=1e-2,
        rtol=1e-2,
    )


def test_SpectralFunction_band_indices(si_pbesol: Phono3py):
    """Spectral function of Si."""
    si_pbesol.mesh_numbers = [9, 9, 9]
    si_pbesol.band_indices = [[4, 5]]
    si_pbesol.init_phph_interaction()
    sf = SpectralFunction(
        si_pbesol.phph_interaction,
        si_pbesol.grid.grg2bzg[[1, 103]],
        temperatures=[
            300,
        ],
        num_frequency_points=10,
        log_level=1,
    )
    sf.run()

    # for line in np.swapaxes(sf.spectral_functions, -2, -1).reshape(-1, 6):
    #     print(("%.7f, " * 6) % tuple(line))
    # raise

    np.testing.assert_allclose(
        np.reshape(shifts, (-1, 6))[:, [4, 5]],
        np.swapaxes(sf.shifts, -2, -1).reshape(-1, 2),
        atol=1e-2,
    )
    np.testing.assert_allclose(
        np.reshape(spec_funcs, (-1, 6))[:, [4, 5]],
        np.swapaxes(sf.spectral_functions, -2, -1).reshape(-1, 2),
        atol=1e-2,
        rtol=1e-2,
    )
